var async = require('async');

module.exports = function(nickname, senderID, token, currentlyVerifying, steamClient, teamspeakClient, config) {

    async.waterfall([
        function(callback) {
            //  Search for nickname and get client id.

            teamspeakClient.send("clientfind", {pattern: nickname}, function (err, response) {
                if (typeof err !== "undefined") {
                    //  If err 512 the user wasnt found, other errors might be on the server side instead aka LOGGED
                    //  internal errors usually mean server side errors in this case, if you don't know whats wrong:
                    //  please report them at https://github.com/nikitavondel/steam-ts
                    if (err.id == 512) {
                        steamClient.chatMessage(senderID, "User was not found on the TeamSpeak server, use !verify to restart the process.");
                        delete currentlyVerifying[senderID.accountid];
                        callback(err);
                    } else {
                        console.log(JSON.stringify(err));
                        console.log("Internal error while looking for: " + nickname);
                        steamClient.chatMessage(senderID, "Something went wrong, either retry !verify or contact an admin please!");
                        delete currentlyVerifying[senderID.accountid];
                        callback(err);
                    }
                } else {
                    //  If user was found, get their clientid

                    var user_clid = response.clid;

                    console.log(nickname + " was found, getting group...");
                    //  If there are multiple results tell the user to temporarily change their name.
                    if (response.constructor == Array) {
                        console.log(nickname + " nickname not specific enough");
                        steamClient.chatMessage(senderID, "Too many current users contain this character set in their name, please temporarily adjust your name and restart this verification process using !verify.");
                        delete currentlyVerifying[senderID.accountid];
                        callback("Too many results.");
                    } else {
                        callback(null, user_clid);
                    }
                }
            })
        },
        function(user_clid, callback) {
            //  Get their groupID

            teamspeakClient.send("clientinfo", {clid: user_clid}, function (err, response) {
                if (typeof err !== "undefined") {
                    console.log("Internal error, verification failed: " + JSON.stringify(err));
                    callback(err);
                    steamClient.chatMessage(senderID, "Something went wrong, either retry !verify or contact an admin please!");
                    delete currentlyVerifying[senderID.accountid];
                } else {
                    //  Group found , run simple logic to check whether they are already verified or not.

                    var found = false,
                        i;

                    if (typeof response.client_servergroups === "string") {
                        //  The user has multiple groups assigned to them.

                        var groups = response.client_servergroups.split(',');

                        for(i=0;i<groups.length;i++) {

                            if (parseInt(groups[i]) == config.wantedrankid) {
                                found = true;
                                break;
                            }

                        }

                        if (found) {
                            steamClient.chatMessage(senderID, "This TeamSpeak user is already verified.");
                            callback(true);
                        } else {
                            callback(null, user_clid);
                        }

                    } else {
                        //  The user has just one single group, ezpz

                        if (response.client_servergroups == config.wantedrankid) {
                            steamClient.chatMessage(senderID, "This TeamSpeak user is already verified.");
                            callback(true);
                        } else {
                            callback(null, user_clid);
                        }

                    }

                }
            })
        },
        function(user_clid, callback) {
            var sendersteamid3 = "[U:1:" + senderID.accountid + "]";
            var sendmessage = "Random token: " + token + "\nGenerated by: " + sendersteamid3 + "\nThis is an automated message, if you didn't use !verify please report the above steamID3 to a staff member.";
            teamspeakClient.send("clientkick", { clid: user_clid, reasonid: 4}, function (err) {
                if (typeof err !== "undefined") {
                    steamClient.chatMessage(senderID, "Something went wrong, either retry !kick or contact an admin please!");
                    console.log(JSON.stringify(err));
                    delete currentlyVerifying[senderID.accountid];
                    callback(err);
                } else {
                    currentlyVerifying[senderID.accountid].clid = user_clid;
                    callback(null);
                }
            });
        }
    ], function (err) {
        if (err != null) {
            delete currentlyVerifying[senderID.accountid];
        } else {
            steamClient.chatMessage(senderID, "We have sent you a message in TeamSpeak including a random token. Please copy paste the specified token here:");
        }
    });
};
